#!/bin/bash
# By Oletros

rndstr=`tr -dc 'A-Z0-9' < /dev/urandom | head -c 12`

if [ ! -d results/ ]; then
    mkdir results/
fi

if [ -e results/$dt.txt ]; then
    mv results/$dt.txt results/$dt-$rndstr.txt
fi

dt=`date +%Y-%m-%d`
year=`date +%Y`
adultyear=`echo "$year - 25" | bc`

rnd=`shuf -i 10000-99999 -n 1`

pseudo=`tr -dc 'A-Z0-9' < /dev/urandom | head -c 8`

totaladdress=`cat resources/address.txt | shuf -n 1`
address=`echo "$totaladdress" | cut -d'|' -f1 | tr ' ' '+'`
postal=`echo "$totaladdress" | cut -d'|' -f2 | tr ' ' '+'`

name=`cat resources/names.txt | shuf -n 1 | tr '[:lower:]' '[:upper:]'`
surname=`cat resources/surnames.txt | shuf -n 1 | tr '[:lower:]' '[:upper:]'`
useragent=`cat resources/user-agent.txt | shuf -n 1`

birthyear=`shuf -i 1950-$adultyear -n 1`
birthmonth=`shuf -i 1-12 -n 1`
birthday=`shuf -i 1-28 -n 1`

email="$name""$surname""$birthyear""$rnd""@nvc-e.com"

result=`curl -s "https://ecard-ca.quipugroup.net/ecardserver.php?beforeSend=off&dataType=json&method=register&language=en&libraryID=33&libraryKey=1beedc665027b4cbd4c78053fa113e0c&reCaptcha=false&reCaptchaResponse=&eCARDEligibility=Resident&eCARDFirstName=$name&eCARDMiddleName=&eCARDLastName=$surname&eCARDStreetResidence=$address&eCARDAptResidence=&eCARDCityResidence=Hamilton&eCARDStateResidence=ON&eCARDPostalCodeResidence=$postal&eCARDMailingSame=true&eCARDStreetMailing=&eCARDAptMailing=&eCARDCityMailing=&eCARDStateMailing=ON&eCARDPostalCodeMailing=&eCARDPhoneAreaCode=&eCARDPhonePrefix=&eCARDPhoneNumber=&eCARDEmail=$email&eCARDDOBYear=$birthyear&eCARDDOBMonth=$birthmonth&eCARDDOBDay=$birthday&eCARDAdult=true&eCARDNewsletter=N&eCARDBranchID_location=1&eCARDBranchID_selected=1&eCARDBranchID=1&eCARDGuardianFirstName=&eCARDGuardianLastName=&eCARDGuardianPhoneAreaCode=&eCARDGuardianPhonePrefix=&eCARDGuardianPhoneNumber=&eCARDGuardianEmail=&eCARDAltEmail=&eCARDPassword=$birthyear&eCARDWorkSchoolName=" -H "User-Agent: $useragent" -H "Accept: application/json, text/javascript, */*; q=0.01" -H "Accept-Language: en-US,en;q=0.5" --compressed -H "Origin: https://www.hpl.ca" -H "DNT: 1" -H "Connection: keep-alive" -H "Referer: https://www.hpl.ca/" -H "Sec-Fetch-Dest: empty" -H "Sec-Fetch-Mode: cors" -H "Sec-Fetch-Site: cross-site" -H "Pragma: no-cache" -H "Cache-Control: no-cache"`

status=`echo "$result" | jq .status | cut -d'"' -f2`
if [ "$status" == "Failed" ]; then
    echo -e "\\e[1;91m""IP: FAILED""\\e[0;0m"
    exit 1
else
    echo -e "\\e[1;92m""IP: SUCCESS""\\e[0;0m"
fi

if [ "$result" != "" ]; then
    barcode=`echo "$result" | jq .eCARDRegistrants[].barcode | sed 's;";;g'`
    password=`echo "$result" | jq .eCARDRegistrants[].password | sed 's;";;g'`

    if [ "$barcode" != "" ] && [ "$password" != "" ]; then
        echo -e "\\e[1;92m""Creation Process: SUCCESS""\\e[0;0m"
        loginrequest=`curl -s -L 'https://hpl.bibliocommons.com/user/login?destination=user_dashboard' -H "User-Agent: $useragent" -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Referer: https://hpl.bibliocommons.com/user/login?destination=user_dashboard' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: https://hpl.bibliocommons.com' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' -H 'Sec-GPC: 1' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data-raw "utf8=%E2%9C%93&name=$barcode&user_pin=$password&local=false&commit=Log+In" -b /tmp/cookie_$rndstr.txt -c /tmp/cookie_$rndstr.txt`

        authenticitytoken=`echo "$loginrequest" | grep -Eo '<meta content="(.*)" name="csrf-token"' | cut -d'"' -f2`
        atue=`python3 -c "import urllib.parse, sys; print(urllib.parse.quote('$authenticitytoken'))"`

        saverequest=`curl -s -L 'https://hpl.bibliocommons.com/user/registration_save' -H "User-Agent: $useragent" -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' --compressed -H 'Referer: https://hpl.bibliocommons.com/user/registration_save' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: https://hpl.bibliocommons.com' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' -H 'Sec-GPC: 1' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data-raw "utf8=%E2%9C%93&authenticity_token=$atue&registration_type=ILS_BACKED&first_name=$name&last_name=$surname&user_email=$email&birth_month=$birthmonth&birth_year=$birthyear&color=Pick+a+Colour&animal=Pick+an+Animal&user_name=$pseudo&accept_terms=1&commit=Register&barcode=$barcode&user_pin=$password" -b /tmp/cookie_$rndstr.txt -c /tmp/cookie_$rndstr.txt`

        saveloggedin=`echo "$saverequest" | jq .logged_in | sed 's;";;g'`
        savesuccess=`echo "$saverequest" | jq .success | sed 's;";;g'`

        if [ "$saveloggedin" != "true" ] && [ "$savesuccess" != "true" ]; then
            echo -e "\\e[1;93m""Auto Registration Process: FAILED.\nYou need to complete registration manually by login here: https://hpl.bibliocommons.com/user/login?destination=user_dashboard""\\e[0;0m"
        else
            echo -e "\\e[1;92m""Auto Registration Process: SUCCESS""\\e[0;0m"
        fi

        finalresult="$barcode:$password|$email,$name,$surname,$birthyear,$birthmonth,$birthday|$pseudo|https://www.linkedin.com/learning-login/go/account/70820388"

        echo "$finalresult" >> results/$dt.txt

        echo -e "\\e[1;94m""~> $finalresult""\\e[0;0m""\n"
    else
        echo -e "\\e[1;91m""Creation Process: FAILED""\\e[0;0m"
    fi
fi

if [ -e /tmp/cookie_$rndstr.txt ]; then
    rm /tmp/cookie_$rndstr.txt
fi

exit 0
